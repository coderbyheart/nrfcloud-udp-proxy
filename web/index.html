<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>nRF Connect for Cloud UDP Proxy Map</title>
    <link
      rel="stylesheet"
      href="https://necolas.github.io/normalize.css/8.0.1/normalize.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <style type="text/css">
      html,
      body {
        height: 100%;
      }
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
      async
    ></script>
    <script type="text/javascript">
      window.onload = () => {
        const map = L.map("map");
        map.setView([51.505, -0.09], 13);

        L.tileLayer(
          "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",
          {
            maxZoom: 18,
            attribution:
              'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
              '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
              'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: "mapbox/streets-v11"
          }
        ).addTo(map);

        const connection = new WebSocket(
          document.location.href.replace(/^https?/, "ws")
        );
        connection.onopen = () => {
          console.debug("[ws]", "open");
        };
        connection.onerror = error => {
          console.error("[ws]", error);
        };
        connection.onmessage = message => {
          console.debug("[ws]", "message", message);
          const { deviceId, latitude, longitude } = JSON.parse(message.data);
          console.log({ deviceId, latitude, longitude });
          map.setView([latitude, longitude], 13);
        };

        fetch(`${document.location.href}locations`)
          .then(res => res.json())
          .then(console.log);
      };
    </script>
  </body>
</html>
